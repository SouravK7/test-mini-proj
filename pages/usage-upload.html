<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Usage | COET Ground Booking</title>
    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/pages.css">
    <link rel="stylesheet" href="../css/theme-toggle.css">
    <script src="../js/theme.js"></script>
</head>

<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="sidebar-logo-icon"><i class="fa-solid fa-landmark"></i></div><span>Ground Booking</span>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <a href="dashboard.html" class="nav-item"><span class="nav-item-icon"><i
                                class="fa-solid fa-chart-bar"></i></span>Dashboard</a>
                    <a href="resources.html" class="nav-item"><span class="nav-item-icon"><i
                                class="fa-solid fa-futbol"></i></span>Resources</a>
                    <a href="calendar.html" class="nav-item"><span class="nav-item-icon"><i
                                class="fa-solid fa-calendar-days"></i></span>Calendar</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Bookings</div>
                    <a href="booking-form.html" class="nav-item"><span class="nav-item-icon"><i
                                class="fa-solid fa-plus"></i></span>New Booking</a>
                    <a href="my-bookings.html" class="nav-item"><span class="nav-item-icon"><i
                                class="fa-solid fa-clipboard-list"></i></span>My Bookings</a>
                </div>
                <div class="nav-section" data-role="user,faculty,admin">
                    <div class="nav-section-title">Usage Management</div>
                    <a href="usage-upload.html" class="nav-item active" data-role="user,faculty,admin"><span
                            class="nav-item-icon"><i class="fa-solid fa-cloud-arrow-up"></i></span>Upload Usage</a>
                </div>
                <div class="nav-section" data-role="admin">
                    <div class="nav-section-title">Approval & Reports</div>
                    <a href="approvals.html" class="nav-item" data-role="admin"><span class="nav-item-icon"><i
                                class="fa-solid fa-check"></i></span>Approvals</a>
                    <a href="reports.html" class="nav-item" data-role="admin"><span class="nav-item-icon"><i
                                class="fa-solid fa-chart-line"></i></span>Reports</a>
                </div>
            </nav>
            <div class="sidebar-footer">
                <a href="javascript:void(0)" class="nav-item" onclick="AUTH.logout()"><span class="nav-item-icon"><i
                            class="fa-solid fa-right-from-bracket"></i></span>Logout</a>
            </div>
        </aside>

        <main class="main-content">
            <header class="navbar">
                <div class="navbar-left">
                    <button class="btn btn-ghost mobile-menu-btn" aria-label="Menu"><i
                            class="fa-solid fa-bars"></i></button>
                    <h1 class="navbar-title">Upload Usage Record</h1>
                </div>
                <div class="navbar-right">
                    <button class="theme-toggle" aria-label="Toggle theme"><span class="theme-toggle-knob"><i
                                class="fa-solid fa-moon theme-toggle-icon theme-toggle-icon-dark"></i><i
                                class="fa-solid fa-sun theme-toggle-icon theme-toggle-icon-light"></i></span></button>
                    <div class="navbar-user">
                        <div class="navbar-user-info">
                            <div class="navbar-user-name">-</div>
                            <div class="navbar-user-role">Faculty</div>
                        </div>
                        <div class="avatar">--</div>
                    </div>
                </div>
            </header>

            <div class="page-content">
                <div class="page-header">
                    <h2 class="page-title">Usage Record Upload</h2>
                    <p class="page-subtitle">Document the usage of your approved booking</p>
                </div>

                <div class="card" style="max-width: 700px;">
                    <div class="card-body">
                        <form id="usage-form">
                            <div class="form-group">
                                <label class="form-label required" for="booking-select">Select Booking</label>
                                <select id="booking-select" class="form-select" required>
                                    <option value="">Loading approved bookings...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label required" for="gdrive-link">Google Drive Link
                                    (Evidence)</label>
                                <input type="url" id="gdrive-link" class="form-input"
                                    placeholder="https://drive.google.com/drive/folders/..." required />
                                <div class="text-xs text-secondary mt-1">Please ensure the link is accessible to
                                    admin/faculty.</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label required" for="remarks">Remarks</label>
                                <textarea id="remarks" class="form-textarea" rows="4"
                                    placeholder="Describe how the booking went..." required></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="issues">Issues/Problems Faced</label>
                                <textarea id="issues" class="form-textarea" rows="3"
                                    placeholder="Any issues with the facility? (optional)"></textarea>
                            </div>

                            <div class="flex gap-3 mt-6">
                                <button type="submit" class="btn btn-primary btn-lg">Submit Usage Record</button>
                                <a href="dashboard.html" class="btn btn-secondary btn-lg">Cancel</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../js/data.js"></script>
    <script src="../js/notifications.js"></script>
    <script src="../js/validators.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            if (!AUTH.isAuthenticated()) {
                window.location.href = '../login.html';
                return;
            }

            const user = AUTH.getCurrentUser();
            const selectEl = document.getElementById('booking-select');

            // Fetch bookings. If user is a student, API automatically filters to only their bookings.
            // If admin/faculty, they will get all bookings, so we should allow them to see them.
            const result = await API.getBookings({ status: 'approved' });

            if (result.success && result.data.length > 0) {
                const availableBookings = result.data.filter(b => !b.hasUsageRecord);

                if (availableBookings.length > 0) {
                    selectEl.innerHTML = '<option value="">Select an approved booking...</option>';
                    availableBookings.forEach(b => {
                        const date = new Date(b.date).toLocaleDateString();
                        selectEl.innerHTML += `<option value="${b.id}">${b.resource.name} - ${date} (${b.slot.label}) booked by ${b.user.name}</option>`;
                    });
                } else {
                    selectEl.innerHTML = '<option value="">All approved bookings already have a usage record recorded</option>';
                    selectEl.disabled = true;
                    document.getElementById('usage-form').querySelector('button[type="submit"]').disabled = true;
                }
            } else {
                selectEl.innerHTML = '<option value="">No approved bookings found</option>';
                selectEl.disabled = true;
                document.getElementById('usage-form').querySelector('button[type="submit"]').disabled = true;
            }
        });

        document.getElementById('usage-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const bookingId = document.getElementById('booking-select').value;
            const remarks = document.getElementById('remarks').value;
            const issues = document.getElementById('issues').value;
            const gdriveLink = document.getElementById('gdrive-link').value;

            if (!bookingId || !remarks || !gdriveLink) {
                Notifications.error('Error', 'Please fill in required fields');
                return;
            }

            const result = await API.createUsageRecord({ bookingId, remarks, issues, gdriveLink });

            if (result.success) {
                Notifications.success('Success', 'Usage record uploaded successfully');
                setTimeout(() => window.location.href = 'dashboard.html', 1500);
            } else {
                Notifications.error('Error', result.error || 'Failed to upload');
            }
        });
    </script>
</body>

</html>