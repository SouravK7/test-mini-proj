<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Booking | COET Ground Booking</title>
    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/pages.css">
    <link rel="stylesheet" href="../css/theme-toggle.css">
    <script src="../js/theme.js"></script>
    <style>
        .resource-preview {
            display: none;
            padding: var(--space-4);
            background: var(--color-primary-50);
            border-radius: var(--radius-md);
            margin-top: var(--space-3);
            border-left: 4px solid var(--color-primary);
        }

        .resource-preview.active {
            display: block;
        }

        .resource-preview h4 {
            margin-bottom: var(--space-2);
            color: var(--color-primary);
        }

        .resource-preview .meta {
            display: flex;
            gap: var(--space-4);
            flex-wrap: wrap;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .slot-grid-booking {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-3);
        }

        @media (max-width: 600px) {
            .slot-grid-booking {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .slot-option {
            padding: var(--space-3);
            border: 2px solid var(--border-default);
            border-radius: var(--radius-md);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .slot-option:hover:not(.disabled) {
            border-color: var(--color-primary);
            background: var(--color-primary-50);
        }

        .slot-option.selected {
            border-color: var(--color-primary);
            background: var(--color-primary);
            color: white;
        }

        .slot-option.disabled {
            background: var(--color-gray-100);
            color: var(--text-disabled);
            cursor: not-allowed;
            text-decoration: line-through;
        }

        .slot-option .slot-time {
            font-weight: 600;
            font-size: 14px;
        }

        .slot-option .slot-status {
            font-size: 12px;
            margin-top: 4px;
        }

        .custom-time-section {
            margin-top: var(--space-4);
            padding: var(--space-4);
            background: var(--color-gray-50);
            border-radius: var(--radius-md);
            border: 2px dashed var(--border-default);
        }

        .custom-time-section.active {
            border-color: var(--color-primary);
            background: var(--color-primary-50);
        }

        .time-inputs {
            display: flex;
            gap: var(--space-4);
            margin-top: var(--space-3);
        }

        .time-inputs .form-group {
            flex: 1;
            margin: 0;
        }

        .date-picker-wrapper {
            display: flex;
            gap: var(--space-3);
            align-items: center;
        }

        .date-picker-wrapper input[type="date"] {
            flex: 1;
        }

        .date-quick-btns {
            display: flex;
            gap: var(--space-2);
        }

        .date-quick-btns button {
            white-space: nowrap;
        }
    </style>
</head>

<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="sidebar-logo-icon">üèõÔ∏è</div><span>Ground Booking</span>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <a href="dashboard.html" class="nav-item"><span class="nav-item-icon">üìä</span>Dashboard</a>
                    <a href="resources.html" class="nav-item"><span class="nav-item-icon">üèüÔ∏è</span>Resources</a>
                    <a href="calendar.html" class="nav-item"><span class="nav-item-icon">üìÖ</span>Calendar</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Bookings</div>
                    <a href="booking-form.html" class="nav-item active"><span class="nav-item-icon">‚ûï</span>New
                        Booking</a>
                    <a href="my-bookings.html" class="nav-item"><span class="nav-item-icon">üìã</span>My Bookings</a>
                </div>
                <div class="nav-section" data-role="faculty,admin">
                    <div class="nav-section-title">Faculty</div>
                    <a href="usage-upload.html" class="nav-item" data-role="faculty,admin"><span
                            class="nav-item-icon">üì§</span>Upload Usage</a>
                </div>
                <div class="nav-section" data-role="admin">
                    <div class="nav-section-title">Admin</div>
                    <a href="approvals.html" class="nav-item" data-role="admin"><span
                            class="nav-item-icon">‚úì</span>Approvals</a>
                    <a href="reports.html" class="nav-item" data-role="admin"><span
                            class="nav-item-icon">üìà</span>Reports</a>
                </div>
            </nav>
            <div class="sidebar-footer">
                <a href="javascript:void(0)" class="nav-item" onclick="AUTH.logout()"><span
                        class="nav-item-icon">üö™</span>Logout</a>
            </div>
        </aside>

        <main class="main-content">
            <header class="navbar">
                <div class="navbar-left">
                    <button class="btn btn-ghost mobile-menu-btn">‚ò∞</button>
                    <h1 class="navbar-title">New Booking Request</h1>
                </div>
                <div class="navbar-right">
                    <button class="theme-toggle" aria-label="Toggle theme"><span
                            class="theme-toggle-knob"></span></button>
                    <div class="navbar-user">
                        <div class="navbar-user-info">
                            <div class="navbar-user-name">-</div>
                            <div class="navbar-user-role">-</div>
                        </div>
                        <div class="avatar">--</div>
                    </div>
                </div>
            </header>

            <div class="page-content">
                <form id="booking-form">
                    <!-- Step 1: Select Resource -->
                    <div class="card mb-6">
                        <div class="card-header">
                            <h3 class="card-title">üìç Step 1: Select Resource</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label required" for="resource-select">Choose a Playground</label>
                                <select id="resource-select" name="resource-select" class="form-select" required>
                                    <option value="">-- Select a playground --</option>
                                </select>
                            </div>
                            <div id="resource-preview" class="resource-preview">
                                <h4 id="preview-name">Resource Name</h4>
                                <div class="meta">
                                    <span id="preview-status">‚úì Available</span>
                                </div>
                                <p id="preview-description" class="text-sm mt-3" style="color: var(--text-secondary);">
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Select Date -->
                    <div class="card mb-6">
                        <div class="card-header">
                            <h3 class="card-title">üìÖ Step 2: Select Date</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label required" for="booking-date">Booking Date</label>
                                <div class="date-picker-wrapper">
                                    <input type="date" id="booking-date" name="booking-date" class="form-input"
                                        required>
                                    <div class="date-quick-btns">
                                        <button type="button" class="btn btn-ghost btn-sm"
                                            onclick="setDate(0)">Today</button>
                                        <button type="button" class="btn btn-ghost btn-sm"
                                            onclick="setDate(1)">Tomorrow</button>
                                        <button type="button" class="btn btn-ghost btn-sm" onclick="setDate(7)">Next
                                            Week</button>
                                    </div>
                                </div>
                                <p class="form-hint">Select the date you want to book the resource</p>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Select Time Slot -->
                    <div class="card mb-6">
                        <div class="card-header">
                            <h3 class="card-title">‚è∞ Step 3: Select Time Slot</h3>
                        </div>
                        <div class="card-body">
                            <p class="text-sm text-secondary mb-4" id="slot-instruction">Select a resource and date
                                first to see available slots</p>

                            <div id="slots-container" style="display: none;">
                                <label class="form-label required">Available Time Slots</label>
                                <p class="text-sm text-secondary mb-3">Click to select one or more consecutive slots</p>
                                <div id="slot-grid" class="slot-grid-booking"></div>
                                <input type="hidden" id="selected-slots" name="selected-slots">

                                <!-- Custom Time Option -->
                                <div class="custom-time-section" id="custom-time-section">
                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" id="use-custom-time" class="form-check-input">
                                        <label for="use-custom-time" class="form-check-label font-semibold">
                                            üïê Need a custom time slot?
                                        </label>
                                    </div>
                                    <p class="text-sm text-secondary mt-2">If the preset slots don't work for you,
                                        specify your preferred time below.</p>
                                    <div class="time-inputs" id="custom-time-inputs" style="display: none;">
                                        <div class="form-group">
                                            <label class="form-label">Start Time</label>
                                            <input type="time" id="custom-start" class="form-input" min="06:00"
                                                max="20:00">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">End Time</label>
                                            <input type="time" id="custom-end" class="form-input" min="06:00"
                                                max="20:00">
                                        </div>
                                    </div>
                                    <p class="text-xs text-secondary mt-2" id="custom-time-note" style="display: none;">
                                        ‚ö†Ô∏è Custom time requests require special approval and may take longer to process.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Purpose -->
                    <div class="card mb-6">
                        <div class="card-header">
                            <h3 class="card-title">üìù Step 4: Booking Details</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label required" for="purpose">Purpose of Booking</label>
                                <textarea id="purpose" name="purpose" class="form-textarea" rows="4"
                                    placeholder="Describe the purpose of your booking (e.g., Cricket practice for inter-college tournament, Community event, etc.)"
                                    required></textarea>
                                <p class="form-hint">Provide enough detail to help admins understand your request
                                    (minimum 10 characters)</p>
                            </div>

                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label" for="expected-attendees">Expected Number of Attendees</label>
                                <input type="number" id="expected-attendees" class="form-input" placeholder="e.g., 25"
                                    min="1" max="500">
                                <p class="form-hint">Optional - helps us prepare the facility</p>
                            </div>
                        </div>
                    </div>

                    <!-- Submit -->
                    <div class="flex gap-3">
                        <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                            ‚úì Submit Booking Request
                        </button>
                        <a href="calendar.html" class="btn btn-secondary btn-lg">Cancel</a>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script src="../js/data.js"></script>
    <script src="../js/notifications.js"></script>
    <script src="../js/validators.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/app.js"></script>
    <script>
        let selectedSlots = [];
        let currentResource = null;

        // Initialize
        const dateInput = document.getElementById('booking-date');
        dateInput.min = Utils.getToday();
        dateInput.value = Utils.getToday();

        // Load resources from API
        const resourceSelect = document.getElementById('resource-select');
        async function loadResources() {
            const result = await API.getResources({ status: 'available' });
            if (result.success) {
                result.data.forEach(r => {
                    const option = document.createElement('option');
                    option.value = r.id;
                    option.textContent = r.name;
                    resourceSelect.appendChild(option);
                });
            }
        }
        loadResources();

        // URL params pre-fill
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('resource')) {
            resourceSelect.value = urlParams.get('resource');
            showResourcePreview(urlParams.get('resource'));
        }
        if (urlParams.get('date')) {
            dateInput.value = urlParams.get('date');
        }

        // Resource selection change
        resourceSelect.addEventListener('change', function () {
            showResourcePreview(this.value);
            loadSlots();
        });

        // Date change
        dateInput.addEventListener('change', loadSlots);

        // Custom time toggle
        document.getElementById('use-custom-time').addEventListener('change', function () {
            const inputs = document.getElementById('custom-time-inputs');
            const note = document.getElementById('custom-time-note');
            const section = document.getElementById('custom-time-section');

            if (this.checked) {
                inputs.style.display = 'flex';
                note.style.display = 'block';
                section.classList.add('active');
                // Clear selected preset slots
                selectedSlots = [];
                document.querySelectorAll('.slot-option.selected').forEach(el => el.classList.remove('selected'));
            } else {
                inputs.style.display = 'none';
                note.style.display = 'none';
                section.classList.remove('active');
            }
        });

        async function showResourcePreview(resourceId) {
            const preview = document.getElementById('resource-preview');
            if (!resourceId) {
                preview.classList.remove('active');
                currentResource = null;
                return;
            }

            const result = await API.getResourceById(resourceId);
            if (result.success) {
                currentResource = result.data;
                document.getElementById('preview-name').textContent = currentResource.name;
                document.getElementById('preview-status').textContent = '‚úì ' + Utils.capitalize(currentResource.status);
                document.getElementById('preview-description').textContent = currentResource.description;
                preview.classList.add('active');
            }
        }

        function setDate(daysFromToday) {
            const date = new Date();
            date.setDate(date.getDate() + daysFromToday);
            dateInput.value = date.toISOString().split('T')[0];
            loadSlots();
        }

        async function loadSlots() {
            const resourceId = resourceSelect.value;
            const date = dateInput.value;
            const container = document.getElementById('slots-container');
            const grid = document.getElementById('slot-grid');
            const instruction = document.getElementById('slot-instruction');

            if (!resourceId || !date) {
                container.style.display = 'none';
                instruction.style.display = 'block';
                return;
            }

            container.style.display = 'block';
            instruction.style.display = 'none';

            // Get availability from API
            const result = await API.checkAvailability(resourceId, date);
            if (!result.success) {
                grid.innerHTML = '<p>Error loading slots</p>';
                return;
            }

            // Render slots
            grid.innerHTML = result.data.map(slot => {
                const isBooked = !slot.available;
                const isSelected = selectedSlots.includes(slot.id);
                return `
                    <div class="slot-option ${isBooked ? 'disabled' : ''} ${isSelected ? 'selected' : ''}" 
                         data-slot-id="${slot.id}" 
                         data-available="${slot.available}"
                         onclick="${isBooked ? '' : 'toggleSlot(' + slot.id + ', this)'}">
                        <div class="slot-time">${slot.label}</div>
                        <div class="slot-status">${isBooked ? '‚ùå Booked' : '‚úì Available'}</div>
                    </div>
                `;
            }).join('');

            // Pre-select slot from URL
            const preSlot = urlParams.get('slot');
            if (preSlot) {
                const slotElement = document.querySelector(`[data-slot-id="${preSlot}"]`);
                if (slotElement && slotElement.dataset.available === 'true') {
                    toggleSlot(parseInt(preSlot), slotElement);
                }
            }
        }

        function toggleSlot(slotId, element) {
            // Uncheck custom time if selecting preset
            document.getElementById('use-custom-time').checked = false;
            document.getElementById('custom-time-inputs').style.display = 'none';
            document.getElementById('custom-time-note').style.display = 'none';
            document.getElementById('custom-time-section').classList.remove('active');

            const index = selectedSlots.indexOf(slotId);
            if (index > -1) {
                selectedSlots.splice(index, 1);
                element.classList.remove('selected');
            } else {
                selectedSlots.push(slotId);
                element.classList.add('selected');
            }
            document.getElementById('selected-slots').value = selectedSlots.join(',');
        }

        // Form submit
        document.getElementById('booking-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const useCustom = document.getElementById('use-custom-time').checked;
            const customStart = document.getElementById('custom-start').value;
            const customEnd = document.getElementById('custom-end').value;

            // Validation
            if (!resourceSelect.value) {
                Notifications.error('Error', 'Please select a resource');
                return;
            }
            if (!dateInput.value) {
                Notifications.error('Error', 'Please select a date');
                return;
            }
            if (!useCustom && selectedSlots.length === 0) {
                Notifications.error('Error', 'Please select at least one time slot');
                return;
            }
            if (useCustom && (!customStart || !customEnd)) {
                Notifications.error('Error', 'Please specify custom start and end times');
                return;
            }
            if (useCustom && customStart >= customEnd) {
                Notifications.error('Error', 'End time must be after start time');
                return;
            }

            const purpose = document.getElementById('purpose').value;
            if (!purpose || purpose.length < 10) {
                Notifications.error('Error', 'Please provide more details about your booking purpose');
                return;
            }

            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Submitting...';

            const user = AUTH.getCurrentUser();

            // Create booking via API
            const result = await API.createBooking({
                resourceId: parseInt(resourceSelect.value),
                slotId: selectedSlots[0], // Use first selected slot
                date: dateInput.value,
                purpose: purpose
            });

            btn.disabled = false;
            btn.textContent = '‚úì Submit Booking Request';

            if (result.success) {
                Notifications.success('Success!', 'Your booking request has been submitted for approval.');
                setTimeout(() => {
                    window.location.href = 'my-bookings.html';
                }, 1500);
            } else {
                Notifications.error('Error', result.error || 'Failed to submit booking');
            }
        });

        // Initial load
        if (resourceSelect.value && dateInput.value) {
            loadSlots();
        }
    </script>
</body>

</html>