<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar | COET Ground Booking</title>
    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/pages.css">
    <link rel="stylesheet" href="../css/theme-toggle.css">
    <script src="../js/theme.js"></script>
</head>

<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="sidebar-logo-icon"><i class="fa-solid fa-landmark"></i></div><span>Ground Booking</span>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <a href="dashboard.html" class="nav-item"><span class="nav-item-icon"><i
                                class="fa-solid fa-chart-bar"></i></span>Dashboard</a>
                    <a href="resources.html" class="nav-item"><span class="nav-item-icon"><i
                                class="fa-solid fa-futbol"></i></span>Resources</a>
                    <a href="calendar.html" class="nav-item active"><span class="nav-item-icon"><i
                                class="fa-solid fa-calendar-days"></i></span>Calendar</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Bookings</div>
                    <a href="booking-form.html" class="nav-item"><span class="nav-item-icon"><i
                                class="fa-solid fa-plus"></i></span>New Booking</a>
                    <a href="my-bookings.html" class="nav-item"><span class="nav-item-icon"><i
                                class="fa-solid fa-clipboard-list"></i></span>My Bookings</a>
                </div>
                <div class="nav-section" data-role="faculty,admin">
                    <div class="nav-section-title">Usage Management</div>
                    <a href="usage-upload.html" class="nav-item" data-role="faculty,admin"><span
                            class="nav-item-icon"><i class="fa-solid fa-cloud-arrow-up"></i></span>Upload Usage</a>
                </div>
                <div class="nav-section" data-role="admin">
                    <div class="nav-section-title">Approval & Reports</div>
                    <a href="approvals.html" class="nav-item" data-role="admin"><span class="nav-item-icon"><i
                                class="fa-solid fa-check"></i></span>Approvals</a>
                    <a href="reports.html" class="nav-item" data-role="admin"><span class="nav-item-icon"><i
                                class="fa-solid fa-chart-line"></i></span>Reports</a>
                </div>
            </nav>
            <div class="sidebar-footer">
                <a href="javascript:void(0)" class="nav-item" onclick="AUTH.logout()"><span class="nav-item-icon"><i
                            class="fa-solid fa-right-from-bracket"></i></span>Logout</a>
            </div>
        </aside>

        <main class="main-content">
            <header class="navbar">
                <div class="navbar-left">
                    <button class="btn btn-ghost mobile-menu-btn" aria-label="Menu"><i
                            class="fa-solid fa-bars"></i></button>
                    <h1 class="navbar-title">Calendar</h1>
                </div>
                <div class="navbar-right">
                    <button class="theme-toggle" aria-label="Toggle theme"><span class="theme-toggle-knob"><i
                                class="fa-solid fa-moon theme-toggle-icon theme-toggle-icon-dark"></i><i
                                class="fa-solid fa-sun theme-toggle-icon theme-toggle-icon-light"></i></span></button>
                    <div class="navbar-user">
                        <div class="navbar-user-info">
                            <div class="navbar-user-name">-</div>
                            <div class="navbar-user-role">-</div>
                        </div>
                        <div class="avatar">--</div>
                    </div>
                </div>
            </header>

            <div class="page-content">
                <div class="page-header">
                    <h2 class="page-title">Playground Availability</h2>
                    <p class="page-subtitle">View and book available time slots across all resources</p>
                </div>

                <!-- Resource Selection -->
                <div class="card mb-6">
                    <div class="card-body flex gap-4 items-end flex-wrap">
                        <div class="form-group" style="margin: 0; flex: 1; min-width: 200px;">
                            <label class="form-label">Select Playground</label>
                            <select id="resource-select" class="form-select">
                                <option value="">All Playgrounds</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Select Date</label>
                            <input type="date" id="date-select" class="form-input">
                        </div>
                        <button class="btn btn-primary" onclick="loadAvailability()">Check Availability</button>
                    </div>
                </div>

                <!-- Resources Grid -->
                <div id="resources-container" class="resource-grid">
                    <div class="text-center p-6" style="grid-column: 1/-1;">
                        <div class="spinner spinner-lg mx-auto"></div>
                    </div>
                </div>

                <!-- Legend -->
                <div class="card mt-6">
                    <div class="card-body flex gap-6 flex-wrap">
                        <div class="flex items-center gap-2">
                            <div class="time-slot slot-available" style="padding: 4px 12px;">Available</div>
                            <span class="text-sm text-secondary">Click to book</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="time-slot slot-unavailable" style="padding: 4px 12px;">Booked</div>
                            <span class="text-sm text-secondary">Already reserved</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../js/data.js"></script>
    <script src="../js/notifications.js"></script>
    <script src="../js/validators.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/app.js"></script>
    <script>
        // Set default date
        document.getElementById('date-select').value = Utils.getToday();
        document.getElementById('date-select').min = Utils.getToday();

        // Load resources dropdown
        async function init() {
            const select = document.getElementById('resource-select');
            const result = await API.getResources();
            if (result.success) {
                window.allResources = result.data.filter(r => r.status === 'available');
                window.allResources.forEach(r => {
                    const option = document.createElement('option');
                    option.value = r.id;
                    option.textContent = r.name;
                    select.appendChild(option);
                });
            } else {
                window.allResources = [];
            }
            loadAvailability();
        }

        async function loadAvailability() {
            const container = document.getElementById('resources-container');
            const date = document.getElementById('date-select').value;
            const resourceId = document.getElementById('resource-select').value;

            let resourcesToLoad = window.allResources || [];
            if (resourceId) {
                resourcesToLoad = resourcesToLoad.filter(r => r.id == resourceId);
            }

            if (resourcesToLoad.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-state-icon"><i class="fa-solid fa-futbol"></i></div>
                        <div class="empty-state-title">No resources found</div>
                        <div class="empty-state-description">No playgrounds match your selection.</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = '<div class="text-center p-6" style="grid-column: 1/-1;"><div class="spinner spinner-lg mx-auto"></div></div>';

            try {
                const promises = resourcesToLoad.map(async (resource) => {
                    const result = await API.checkAvailability(resource.id, date);
                    return { resource, availability: result.success ? result.data : [] };
                });

                const results = await Promise.all(promises);

                container.innerHTML = results.map(({ resource, availability }) => {
                    // Build timeslot map
                    const slotsHtml = availability.map(slot => {
                        if (!slot.available) {
                            return `<div class="time-slot slot-unavailable">${slot.label}</div>`;
                        } else {
                            return `<div class="time-slot slot-available" style="cursor:pointer;" onclick="bookSlot(${resource.id}, '${date}', ${slot.id})">${slot.label}</div>`;
                        }
                    }).join('');

                    return `
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">${resource.name}</h3>
            </div>
            <div class="card-body">
              <p class="text-sm mb-4">Slots for ${Utils.formatDate(date)}:</p>
              <div class="slot-grid" style="grid-template-columns: repeat(2, 1fr);">
                ${slotsHtml}
              </div>
            </div>
            <div class="card-footer">
              <a href="booking-form.html?resource=${resource.id}&date=${date}" class="btn btn-primary btn-sm"><i class="fa-solid fa-plus"></i> New Booking</a>
            </div>
          </div>
        `;
                }).join('');
            } catch (error) {
                console.error('Failed to parse API output for calendar:', error);
                container.innerHTML = '<div class="text-danger p-6 text-center">Failed to load availability.</div>';
            }
        }

        function bookSlot(resourceId, date, slotId) {
            window.location.href = `booking-form.html?resource=${resourceId}&date=${date}&slot=${slotId}`;
        }

        init();
    </script>
</body>

</html>